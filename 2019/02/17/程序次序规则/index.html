<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="程序次序规则"><meta name="keywords" content="Java, Mr.Thirteen's blog"><link rel="alternate" href="/default" title="Mr.Thirteen's blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="https://at-fieldless.github.io/2019/02/17/程序次序规则/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":"app_id:Ft6e3NGMakjJA8863I2S0Njs-gzGzoHsz app_key:0FzGh29Jey21Jw3XXnTI4TvJ","toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>程序次序规则 - Mr.Thirteen's blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Mr.Thirteen's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Mr.Thirteen's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            标签
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">程序次序规则
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-02-17
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#起因"><span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解答"><span class="toc-text">解答</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引申问题"><span class="toc-text">引申问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
    </div>
  </div><div class="post-content"><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>在学习Java内存模型的时候，有一个先行发生原则，也就是happens-before，其中第一条</p>
<blockquote>
<p>If x and y are actions of the same thread and x comes before y in program order, then hb(x, y)</p>
</blockquote>
<p>这句话的意思是如果在一个线程里里面，x语句书写的顺序在y语句前面，那么x语句就会先行发生于y语句。这也是我们常说的程序次序规则(Program Order Rule)。</p>
<a id="more"></a>
<p>举个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int i = 0;      //x语句</span><br><span class="line">int y = 1;      //y语句</span><br></pre></td></tr></table></figure>
<p>根据程序次序原则，”int i = 0”就会比”int y = 1”先发生，可是在实际情况下，也许会发生指令重排序的现象，导致”int y = 1”比”int i = 0”先运行。</p>
<p>那这样岂不是说明程序次序规则没有在实际运行中体现出来么？</p>
<h2 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h2><p>在stackoverflow有一个和这个有关系的问题</p>
<p><a href="https://stackoverflow.com/questions/15654276/interpretation-of-program-order-rule-in-java-concurrency" target="_blank" rel="noopener">lnterpretation of “program order rule” in Java Concurrency</a></p>
<p>其中最高赞的答主有这么一句话</p>
<blockquote>
<p> “Each action in a thread happens-before every action in that thread that comes later in the program order” is trying to say is, “In a single thread, your program will run as if it was executed in the exact order you wrote it. We might change the ordering behind the scene but we make sure that none of that would change the output.”</p>
</blockquote>
<p><strong>也就是说在一个单线程里，程序的执行顺序可能会有变化，但只要对运行结果没什么影响即可</strong>。</p>
<h2 id="引申问题"><a href="#引申问题" class="headerlink" title="引申问题"></a>引申问题</h2><p>这个提问者在这个问题下还补充了个小问题，我觉得挺有意思的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">long tick = System.nanoTime(); //Line1: 打时间戳</span><br><span class="line">//Block1: 一段需要计算运行时间的代码</span><br><span class="line">long tock = System.nanoTime(); //Line2: 打时间戳</span><br></pre></td></tr></table></figure>
<p>这是我们常见的用来计算程序运行时间的代码，假设Block1与两个时间戳代码没有什么关联，那会不会出现Line1-&gt;Line2-&gt;Block1的重排序情况？实际情况下肯定是不会出现的，要不然我们怎么计算时间呢？但为什么呢？</p>
<p>高赞答主也顺便解决了这个问题，并提出了一个很有意思的可能。</p>
<p>首先为什么不会发出重排序情况呢？因为System.nanoTime是一次系统调用，<strong>编译器并不知道重排会不会对程序结果造成影响</strong>所以不会进行重排。</p>
<p>那假如我们的java编译器可以控制系统调用的代码，并在合规的情况下可以对它进行重排，那对时间函数的调用会不会发生重排现象呢？这得分两种情况进行讨论了，对于”System.nanoTime”函数来说还是不会发生重排的，因为它本来就是获取相对时间而不是实际时间的，发生重排就没意义了。那如果是”System.currentTimeMillis()”函数呢？就像这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">long tick = System.currentTimeMillis();     //Line1</span><br><span class="line">result = compute();         //Line2</span><br><span class="line">long tock = System.currentTimeMillis();     //Line3</span><br><span class="line">print(result + &quot;:&quot; + tick - tock);</span><br></pre></td></tr></table></figure>
<p>会不会发生Line1-&gt;Line3-&gt;Line2的执行情况？答案是可能的。</p>
<p>首先做个假设，现实时间每过50ms，系统时间发生一次变化，就是说假如现在从”System.currentTimeMillis()”获取的时间是123，那么在现实时间过了50ms后，再运行一次”System.currentTimeMillis()”的结果就会是124。然后只要编译器能保证Line2的执行时间小于50ms，就可以发生Line1-&gt;Line3-&gt;Line2的重排现象。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>所以对于程序次序规则来说，它为什么会作为第一条出现在happens-before里面呢？就是为了确保程序运行的结果要和顺序执行的结果一致，至于会不会重排，只要“You can reorder anything as long as it cannot be detected”就行。</p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://at-fieldless.github.io">thirteen</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://at-fieldless.github.io/2019/02/17/程序次序规则/">https://at-fieldless.github.io/2019/02/17/程序次序规则/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Java/">Java</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2019/09/28/Flink-Window-初探/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Flink Window 初探</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:AT-Fieldless@outlook.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/AT-Fieldless" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">thirteen</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
